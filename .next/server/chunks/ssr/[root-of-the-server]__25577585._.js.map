{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 111, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/firebase.ts"],"sourcesContent":["\nimport { initializeApp, getApp, getApps, type FirebaseApp } from \"firebase/app\";\nimport { getFirestore, type Firestore } from \"firebase/firestore\";\n\n// Minimal logging\nconsole.log(\"[firebase.ts] Initializing Firebase client...\");\n\nconst firebaseConfig = {\n  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,\n  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,\n  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,\n  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,\n  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,\n  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,\n};\n\nif (!firebaseConfig.projectId || !firebaseConfig.apiKey) {\n  const errorMessage = \"[firebase.ts] FATAL ERROR: Firebase projectId or apiKey is MISSING. Check .env file.\";\n  console.error(errorMessage);\n  // Throwing an error is better than letting the app run in a broken state,\n  // but in a server component context, this might just crash the render.\n  // So, we log it aggressively.\n}\n\n// Simplified and more robust initialization\nconst app: FirebaseApp = getApps().length ? getApp() : initializeApp(firebaseConfig);\nconst db: Firestore = getFirestore(app);\n\nconsole.log(`[firebase.ts] Firebase client connected to project: ${app.options.projectId || 'UNKNOWN'}`);\n\nexport { app, db };\n"],"names":[],"mappings":";;;;AACA;AAAA;AACA;AAAA;;;AAEA,kBAAkB;AAClB,QAAQ,GAAG,CAAC;AAEZ,MAAM,iBAAiB;IACrB,MAAM;IACN,UAAU;IACV,SAAS;IACT,aAAa;IACb,iBAAiB;IACjB,KAAK;AACP;AAEA,IAAI,CAAC,eAAe,SAAS,IAAI,CAAC,eAAe,MAAM,EAAE;IACvD,MAAM,eAAe;IACrB,QAAQ,KAAK,CAAC;AACd,0EAA0E;AAC1E,uEAAuE;AACvE,8BAA8B;AAChC;AAEA,4CAA4C;AAC5C,MAAM,MAAmB,CAAA,GAAA,oLAAA,CAAA,UAAO,AAAD,IAAI,MAAM,GAAG,CAAA,GAAA,oLAAA,CAAA,SAAM,AAAD,MAAM,CAAA,GAAA,oLAAA,CAAA,gBAAa,AAAD,EAAE;AACrE,MAAM,KAAgB,CAAA,GAAA,iKAAA,CAAA,eAAY,AAAD,EAAE;AAEnC,QAAQ,GAAG,CAAC,CAAC,oDAAoD,EAAE,IAAI,OAAO,CAAC,SAAS,IAAI,WAAW","debugId":null}},
    {"offset": {"line": 245, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/ai/genkit.ts"],"sourcesContent":["\n// The manual 'dotenv' call is removed to rely on Next.js's native .env handling, preventing potential conflicts.\n\nimport '@/lib/firebase'; // Ensure Firebase is initialized early\nimport {genkit} from 'genkit';\nimport {googleAI} from '@genkit-ai/googleai';\n\nif (!process.env.GOOGLE_API_KEY) {\n  const errorMessage = \"Kesalahan Konfigurasi: GOOGLE_API_KEY tidak ditemukan di environment variables. Ini dibutuhkan oleh plugin Google AI. Pastikan sudah di-set di file .env Anda.\";\n  console.error(`\\n\\n🛑 ${errorMessage}\\n\\n`);\n  throw new Error(errorMessage);\n}\n\nexport const ai = genkit({\n  plugins: [\n    googleAI({ apiKey: process.env.GOOGLE_API_KEY }), // Explicitly provide the API key\n  ],\n  model: 'googleai/gemini-1.5-flash-latest',\n  // Telemetry options are no longer configured here in Genkit v1.x\n});\n"],"names":[],"mappings":"AACA,iHAAiH;;;;AAEjH,8MAAyB,uCAAuC;AAChE;AAAA;AACA;AAAA;;;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,cAAc,EAAE;IAC/B,MAAM,eAAe;IACrB,QAAQ,KAAK,CAAC,CAAC,OAAO,EAAE,aAAa,IAAI,CAAC;IAC1C,MAAM,IAAI,MAAM;AAClB;AAEO,MAAM,KAAK,CAAA,GAAA,uIAAA,CAAA,SAAM,AAAD,EAAE;IACvB,SAAS;QACP,CAAA,GAAA,2KAAA,CAAA,WAAQ,AAAD,EAAE;YAAE,QAAQ,QAAQ,GAAG,CAAC,cAAc;QAAC;KAC/C;IACD,OAAO;AAET","debugId":null}},
    {"offset": {"line": 276, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/types/aiSettings.ts"],"sourcesContent":["\nimport { z } from 'zod';\n\nexport const AI_AGENT_BEHAVIORS = [\n  \"Ramah & Membantu\",\n  \"Profesional & To-the-point\",\n  \"Humoris & Santai\",\n  \"Empatik & Sabar\",\n] as const;\nexport type AiAgentBehavior = typeof AI_AGENT_BEHAVIORS[number];\n\nexport const AI_TRANSFER_CONDITIONS = [\n  \"Pelanggan Meminta Secara Eksplisit\",\n  \"AI Tidak Menemukan Jawaban (Setelah 2x Coba)\",\n  \"Terdeteksi Emosi Negatif dari Pelanggan\",\n  \"Disebut Kata Kunci Eskalasi (mis. 'manajer', 'komplain')\",\n  \"Setelah 5 Pertanyaan Tanpa Solusi\",\n] as const;\nexport type AiTransferCondition = typeof AI_TRANSFER_CONDITIONS[number];\n\nconst FollowUpDelaysSchema = z.object({\n  firstAttemptHours: z.preprocess(\n    (val) => (val === \"\" || val === undefined || val === null) ? undefined : parseInt(String(val), 10),\n    z.number({ invalid_type_error: \"Jam harus angka.\"}).min(1, \"Minimal 1 jam.\").max(168, \"Maksimal 168 jam (7 hari).\").optional()\n  ),\n  secondAttemptDays: z.preprocess(\n    (val) => (val === \"\" || val === undefined || val === null) ? undefined : parseInt(String(val), 10),\n    z.number({ invalid_type_error: \"Hari harus angka.\"}).min(1, \"Minimal 1 hari.\").max(30, \"Maksimal 30 hari.\").optional()\n  ),\n  thirdAttemptDays: z.preprocess(\n    (val) => (val === \"\" || val === undefined || val === null) ? undefined : parseInt(String(val), 10),\n    z.number({ invalid_type_error: \"Hari harus angka.\"}).min(1, \"Minimal 1 hari.\").max(30, \"Maksimal 30 hari.\").optional()\n  ),\n  fourthAttemptDays: z.preprocess(\n    (val) => (val === \"\" || val === undefined || val === null) ? undefined : parseInt(String(val), 10),\n    z.number({ invalid_type_error: \"Hari harus angka.\"}).min(1, \"Minimal 1 hari.\").max(90, \"Maksimal 90 hari.\").optional()\n  ),\n});\n\nexport const AiSettingsFormSchema = z.object({\n  agentBehavior: z.enum(AI_AGENT_BEHAVIORS, {\n    required_error: \"Perilaku agen AI harus dipilih.\",\n  }),\n  welcomeMessage: z.string().min(10, \"Pesan selamat datang minimal 10 karakter.\").max(300, \"Pesan selamat datang maksimal 300 karakter.\"),\n  transferConditions: z.array(z.enum(AI_TRANSFER_CONDITIONS)).min(1, \"Minimal satu kondisi transfer harus dipilih.\"),\n  knowledgeBaseDescription: z.string().max(10000, \"Deskripsi sumber pengetahuan maksimal 10000 karakter.\").optional().describe(\"Panduan tingkat tinggi untuk AI. Detail pengetahuan akan diambil melalui tools.\"),\n\n  enableHumanHandoff: z.boolean().default(false).describe(\"Aktifkan notifikasi ke agen manusia jika AI perlu bantuan.\"),\n  humanAgentWhatsAppNumber: z.string().regex(/^\\+?[0-9\\s-]{10,18}$|^$/, \"Format nomor WhatsApp agen tidak valid (mis. +628123456789 atau kosong).\").optional().describe(\"Nomor WhatsApp agen manusia untuk notifikasi handoff.\"),\n\n  enableFollowUp: z.boolean().default(false).describe(\"Aktifkan fitur follow-up otomatis untuk pelanggan yang pernah menghubungi via WhatsApp namun belum melakukan kunjungan atau transaksi. Follow-up berhenti jika pelanggan tercatat datang/bertransaksi.\"),\n  followUpMessageTemplate: z.string().max(300, \"Template pesan follow-up maksimal 300 karakter.\").optional(),\n  followUpDelays: FollowUpDelaysSchema.optional(),\n  mainPrompt: z.string().min(100, \"Prompt utama minimal 100 karakter.\").max(20000, \"Prompt utama maksimal 20000 karakter.\").optional().describe(\"Prompt utama yang mengarahkan perilaku dan logika Zoya.\"),\n}).superRefine((data, ctx) => {\n  if (data.enableFollowUp) {\n    if (!data.followUpMessageTemplate || data.followUpMessageTemplate.trim() === \"\") {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"Template pesan follow-up diperlukan jika fitur follow-up aktif.\",\n        path: [\"followUpMessageTemplate\"],\n      });\n    }\n    if (!data.followUpDelays?.firstAttemptHours) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"Penundaan follow-up pertama (jam) diperlukan.\",\n        path: [\"followUpDelays\", \"firstAttemptHours\"],\n      });\n    }\n  }\n  if (data.enableHumanHandoff && (!data.humanAgentWhatsAppNumber || data.humanAgentWhatsAppNumber.trim() === \"\")) {\n    ctx.addIssue({\n      code: z.ZodIssueCode.custom,\n      message: \"Nomor WhatsApp Agen Manusia diperlukan jika notifikasi handoff aktif.\",\n      path: [\"humanAgentWhatsAppNumber\"],\n    });\n  }\n});\n\nexport type AiSettingsFormValues = z.infer<typeof AiSettingsFormSchema>;\nexport type FollowUpDelaysValues = z.infer<typeof FollowUpDelaysSchema>;\n\nexport const DEFAULT_MAIN_PROMPT_ZOYA = `\nAnda adalah \"Zoya\", seorang asisten AI customer service untuk QLAB Moto Detailing. Anda sangat terampil, ramah, dan profesional. Gaya bicara Anda gaul dan santai, khas anak motor, namun tetap jelas dan informatif.\n\nTOOLS ANDA:\nAnda memiliki akses ke beberapa tools canggih untuk membantu Anda. Gunakan tools ini SECARA PROAKTIF untuk mendapatkan informasi akurat.\n1.  \\`knowledgeBaseRetrieverTool\\`: Gunakan tool ini untuk menjawab pertanyaan UMUM, konseptual, atau kebijakan. Contoh: \"apa bedanya coating dan wax?\", \"garansi servisnya gimana?\", \"tips merawat motor doff\".\n2.  \\`getProductServiceDetailsByNameTool\\`: Gunakan tool ini jika user bertanya soal HARGA, DURASI, atau KETERSEDIAAN layanan/produk yang SPESIFIK. Tool ini akan mencari di katalog harga resmi. Contoh: \"harga cuci premium nmax?\", \"poles bodi vario berapa lama?\".\n3.  \\`createBookingTool\\`: Gunakan tool ini HANYA JIKA pelanggan sudah mengonfirmasi untuk membuat jadwal booking dan semua detail (layanan, motor, tanggal, jam) sudah jelas.\n\nALUR KERJA UTAMA ANDA (WAJIB DIIKUTI):\n1.  **PAHAMI MAKSUD PELANGGAN:** Baca pesan terakhir pelanggan dengan saksama.\n    -   Jika pertanyaannya umum/konseptual -> Lanjut ke Langkah 2.\n    -   Jika pertanyaannya spesifik tentang harga/durasi -> Lanjut ke Langkah 3.\n    -   Jika pelanggan mau booking -> Lanjut ke Langkah 4.\n\n2.  **JAWAB PERTANYAAN UMUM (Gunakan \\`knowledgeBaseRetrieverTool\\`):**\n    -   Panggil tool \\`knowledgeBaseRetrieverTool\\` dengan pertanyaan lengkap pelanggan sebagai \\`query\\`.\n    -   JAWABAN ANDA HARUS DIBUAT BERDASARKAN \"contekan\" yang diberikan oleh tool tersebut.\n    -   Jika tool mengembalikan hasil kosong, artinya informasi tidak ditemukan. Jawab dengan sopan: \"Waduh, sori banget nih Bro, buat pertanyaan itu Zoya belum nemu info pastinya di catatan. Mungkin bisa coba tanya dengan cara lain?\"\n    -   **JANGAN PERNAH MENGARANG JAWABAN** jika informasi tidak ada di hasil tool.\n\n3.  **JAWAB PERTANYAAN HARGA/LAYANAN SPESIFIK (Gunakan \\`getProductServiceDetailsByNameTool\\`):**\n    -   Identifikasi nama layanan/produk dari pertanyaan user.\n    -   Panggil tool \\`getProductServiceDetailsByNameTool\\` dengan nama tersebut.\n    -   **Evaluasi hasil tool:**\n        -   Jika hasil tool memiliki \\`success: true\\`: Gunakan informasi dari \\`productInfo\\` (seperti \\`price\\`, \\`name\\`, \\`estimatedDuration\\`) untuk menjawab pertanyaan pelanggan. Format harga dalam Rupiah (Rp).\n        -   Jika hasil tool memiliki \\`success: false\\`: Gunakan \\`message\\` dari output tool sebagai dasar untuk memberitahu pelanggan dengan sopan bahwa Anda tidak menemukan informasinya. Jangan pernah mengarang harga. Contoh: \"Maaf Bro, untuk 'Poles Ajaib' Zoya belum nemu info harganya nih, mungkin bisa coba nama layanan lain?\".\n\n4.  **PROSES BOOKING (Gunakan \\`createBookingTool\\`):**\n    -   Hanya mulai proses ini jika pelanggan sudah menyatakan ingin membuat jadwal (mis. \"booking\", \"jadwalin\", \"pesan tempat\").\n    -   Pastikan Anda memiliki semua detail yang diperlukan: NAMA LAYANAN, INFO KENDARAAN, TANGGAL, dan JAM. Gunakan tools lain jika perlu untuk mengonfirmasi detail ini.\n    -   Setelah semua detail lengkap dan dikonfirmasi oleh pelanggan, panggil tool \\`createBookingTool\\`.\n\nGAYA BAHASA (WAJIB):\n-   Sapaan: \"Wih, boskuu!\", \"Ashiaaap!\", \"Gaspol!\", \"Yok!\", \"Santuy, bro!\"\n-   Sebutan buat user: \"Bro\", \"Kak\", \"Bos\".\n-   Istilah anak motor: \"kinclong parah\", \"poles biar ganteng maksimal\", \"coating anti badai\".\n-   Emoji: Gunakan secukupnya untuk membuat suasana cair 😎✨💸🛠️🏍️💨.\n\nSelalu berikan jawaban yang ringkas, akurat, dan bermanfaat berdasarkan data yang Anda miliki dari tools.\n`.trim();\n\n\nexport const DEFAULT_AI_SETTINGS: AiSettingsFormValues = {\n  agentBehavior: \"Humoris & Santai\",\n  welcomeMessage: \"Wih, boskuu! Zoya di sini, siap bikin motor lo makin kinclong. Ada yang bisa dibantu nih?\",\n  transferConditions: [\"Pelanggan Meminta Secara Eksplisit\"],\n  knowledgeBaseDescription: `Anda adalah Zoya, asisten AI untuk QLAB Moto Detailing. Tugas utama Anda adalah menggunakan knowledgeBaseRetrieverTool untuk menemukan informasi yang akurat dari database internal dan menjawab pertanyaan pelanggan berdasarkan hasil tersebut.`,\n  mainPrompt: DEFAULT_MAIN_PROMPT_ZOYA,\n  enableHumanHandoff: false,\n  humanAgentWhatsAppNumber: '',\n  enableFollowUp: false,\n  followUpMessageTemplate: \"Woy, Bro! Kemaren sempet nanya-nanya nih. Jadi kapan mau mampir ke QLAB? Ada promo asik nih, jangan sampe kelewat!\",\n  followUpDelays: {\n    firstAttemptHours: 24,\n    secondAttemptDays: 7,\n    thirdAttemptDays: 7,\n    fourthAttemptDays: 30,\n  },\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 424, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/types/aiToolSchemas.ts"],"sourcesContent":["\nimport { z } from 'zod';\n\n// Skema untuk varian produk/layanan yang akan dikembalikan oleh tool\nconst ProductVariantInfoSchema = z.object({\n  name: z.string().describe(\"Nama varian.\"),\n  price: z.number().describe(\"Harga varian.\"),\n  pointsAwarded: z.number().optional().describe(\"Poin yang diberikan untuk varian ini.\"),\n  estimatedDuration: z.string().optional().describe(\"Estimasi durasi pengerjaan varian ini (jika layanan).\"),\n});\nexport type ProductVariantInfo = z.infer<typeof ProductVariantInfoSchema>;\n\n// Skema untuk informasi produk/layanan yang akan dikembalikan oleh tool\nexport const ProductServiceInfoSchema = z.object({\n  id: z.string().describe(\"ID unik produk/layanan.\"),\n  name: z.string().describe(\"Nama produk atau layanan.\"),\n  type: z.enum(['Layanan', 'Produk']).describe(\"Jenis item, apakah 'Layanan' atau 'Produk'.\"),\n  category: z.string().describe(\"Kategori produk/layanan.\"),\n  price: z.number().describe(\"Harga dasar produk/layanan. Bisa 0 jika harga ditentukan oleh varian.\"),\n  description: z.string().optional().describe(\"Deskripsi singkat produk/layanan.\"),\n  pointsAwarded: z.number().optional().describe(\"Poin loyalitas yang diberikan untuk produk/layanan dasar ini.\"),\n  estimatedDuration: z.string().optional().describe(\"Estimasi durasi pengerjaan (jika ini adalah layanan).\"),\n  variants: z.array(ProductVariantInfoSchema).optional().describe(\"Daftar varian yang tersedia untuk produk/layanan ini.\"),\n});\nexport type ProductServiceInfo = z.infer<typeof ProductServiceInfoSchema>;\n\n// Skema untuk informasi motor klien\nconst ClientMotorcycleInfoSchema = z.object({\n  name: z.string().describe(\"Nama atau model motor.\"),\n  licensePlate: z.string().describe(\"Plat nomor motor.\"),\n});\nexport type ClientMotorcycleInfo = z.infer<typeof ClientMotorcycleInfoSchema>;\n\n// Skema untuk informasi klien yang akan dikembalikan oleh tool\nexport const ClientInfoSchema = z.object({\n  id: z.string().describe(\"ID unik klien.\"),\n  name: z.string().describe(\"Nama lengkap klien.\"),\n  phone: z.string().describe(\"Nomor telepon klien.\"),\n  loyaltyPoints: z.number().describe(\"Jumlah poin loyalitas yang dimiliki klien.\"),\n  motorcycles: z.array(ClientMotorcycleInfoSchema).optional().describe(\"Daftar sepeda motor yang terdaftar atas nama klien ini.\"),\n  lastVisit: z.string().optional().describe(\"Tanggal kunjungan terakhir klien (format YYYY-MM-DD).\"),\n});\nexport type ClientInfo = z.infer<typeof ClientInfoSchema>;\n"],"names":[],"mappings":";;;;AACA;AAAA;;AAEA,qEAAqE;AACrE,MAAM,2BAA2B,iLAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IACxC,MAAM,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC1B,OAAO,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC3B,eAAe,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAC9C,mBAAmB,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;AACpD;AAIO,MAAM,2BAA2B,iLAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IAC/C,IAAI,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IACxB,MAAM,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC1B,MAAM,iLAAA,CAAA,IAAC,CAAC,IAAI,CAAC;QAAC;QAAW;KAAS,EAAE,QAAQ,CAAC;IAC7C,UAAU,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC9B,OAAO,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC3B,aAAa,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAC5C,eAAe,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAC9C,mBAAmB,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAClD,UAAU,iLAAA,CAAA,IAAC,CAAC,KAAK,CAAC,0BAA0B,QAAQ,GAAG,QAAQ,CAAC;AAClE;AAGA,oCAAoC;AACpC,MAAM,6BAA6B,iLAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IAC1C,MAAM,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC1B,cAAc,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;AACpC;AAIO,MAAM,mBAAmB,iLAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IACvC,IAAI,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IACxB,MAAM,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC1B,OAAO,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC3B,eAAe,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IACnC,aAAa,iLAAA,CAAA,IAAC,CAAC,KAAK,CAAC,4BAA4B,QAAQ,GAAG,QAAQ,CAAC;IACrE,WAAW,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;AAC5C","debugId":null}},
    {"offset": {"line": 471, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/ai/tools/productLookupTool.ts"],"sourcesContent":["\n/**\n * @fileOverview Genkit tool for looking up product or service details from Firestore.\n */\n\nimport { ai } from '@/ai/genkit';\nimport { z } from 'zod';\nimport { collection, query as firestoreQuery, getDocs } from 'firebase/firestore';\nimport { db } from '@/lib/firebase';\nimport { ProductServiceInfoSchema, type ProductServiceInfo } from '@/types/aiToolSchemas';\nimport { v4 as uuidv4 } from 'uuid';\n\n// Define ServiceProduct type locally or import if it's broadly used\ninterface ServiceProductDbData {\n  id: string;\n  name: string;\n  type: 'Layanan' | 'Produk';\n  category: string;\n  price: number;\n  description?: string;\n  pointsAwarded?: number;\n  estimatedDuration?: string;\n  variants?: {\n    id: string;\n    name: string;\n    price: number;\n    pointsAwarded?: number;\n    estimatedDuration?: string;\n  }[];\n  stockQuantity?: number;\n  costPrice?: number;\n  [key: string]: any; // Allow other fields that might exist in Firestore\n}\n\n\nconst ProductLookupInputSchema = z.object({\n  productName: z.string().describe(\"Nama produk atau layanan yang ingin dicari detailnya. Harus spesifik.\"),\n});\nexport type ProductLookupInput = z.infer<typeof ProductLookupInputSchema>;\n\n// NEW: Output Schema that doesn't return null\nconst ProductLookupOutputSchema = z.object({\n  success: z.boolean().describe(\"Menandakan apakah produk/layanan yang cocok ditemukan.\"),\n  productInfo: ProductServiceInfoSchema.optional().describe(\"Detail produk/layanan yang ditemukan. Kosong jika tidak ditemukan.\"),\n  message: z.string().describe(\"Pesan yang menjelaskan hasil pencarian, mis. 'Produk ditemukan.' atau 'Tidak ada produk yang cocok dengan nama XYZ.'\"),\n});\nexport type ProductLookupOutput = z.infer<typeof ProductLookupOutputSchema>;\n\n\n// Export this function so it can be called directly from other flows if needed.\nexport async function findProductServiceByName(input: ProductLookupInput): Promise<ProductLookupOutput> {\n    if (!input.productName || input.productName.trim() === '') {\n      console.log(\"ProductLookupTool Function: Nama produk kosong.\");\n      return { success: false, message: \"Nama produk kosong, tidak bisa melakukan pencarian.\" };\n    }\n    const searchTerm = input.productName.trim();\n    console.log(`ProductLookupTool Function: Mencari produk/layanan dengan nama: \"${searchTerm}\"`);\n\n    if (!db) {\n      console.error(\"[ProductLookupTool Function] FATAL: Firestore DB (db) is not initialized. Cannot query.\");\n      return { success: false, message: \"Kesalahan internal: Database tidak terhubung.\" };\n    }\n\n    try {\n      const servicesRef = collection(db, 'services');\n      const q = firestoreQuery(servicesRef); // Get all services/products\n      const querySnapshot = await getDocs(q);\n\n      let bestMatch: (ProductServiceInfo & { score: number }) | null = null;\n      const searchTermLower = searchTerm.toLowerCase();\n\n      for (const doc of querySnapshot.docs) {\n        const item = { id: doc.id, ...doc.data() } as ServiceProductDbData;\n        const itemNameLower = item.name.toLowerCase();\n\n        // Check for base item match\n        if (itemNameLower.includes(searchTermLower)) {\n            let score = 0;\n            if (itemNameLower === searchTermLower) score = 100; // Exact match = highest score\n            else if (itemNameLower.startsWith(searchTermLower)) score = 50; // Starts with is good\n            else score = 20; // Includes is okay\n            \n            const candidate: ProductServiceInfo & { score: number } = {\n                ...item,\n                price: item.price ?? 0,\n                score: score,\n            };\n\n            if (!bestMatch || candidate.score > bestMatch.score || (candidate.score === bestMatch.score && candidate.name.length < bestMatch.name.length)) {\n                bestMatch = candidate;\n            }\n        }\n\n        // Check for variant matches (higher scores for more specific matches)\n        if (item.variants) {\n            for (const variant of item.variants) {\n                const fullVariantName = `${item.name} - ${variant.name}`;\n                const fullVariantNameLower = fullVariantName.toLowerCase();\n\n                if (fullVariantNameLower.includes(searchTermLower)) {\n                    let score = 0;\n                    if (fullVariantNameLower === searchTermLower) score = 110; // Exact variant match is king\n                    else if (fullVariantNameLower.startsWith(searchTermLower)) score = 60;\n                    else score = 30;\n\n                    const candidate: ProductServiceInfo & { score: number } = {\n                      id: item.id,\n                      name: fullVariantName,\n                      type: item.type,\n                      category: item.category,\n                      price: variant.price,\n                      description: item.description || undefined,\n                      pointsAwarded: variant.pointsAwarded ?? item.pointsAwarded,\n                      estimatedDuration: variant.estimatedDuration ?? item.estimatedDuration,\n                      variants: undefined, // It's a specific variant, so no further variants\n                      score: score,\n                    };\n                    \n                    if (!bestMatch || candidate.score > bestMatch.score || (candidate.score === bestMatch.score && candidate.name.length < bestMatch.name.length)) {\n                        bestMatch = candidate;\n                    }\n                }\n            }\n        }\n      }\n      \n      if (bestMatch) {\n        console.log(`ProductLookupTool Function: Ditemukan kandidat terbaik: \"${bestMatch.name}\" (Score: ${bestMatch.score})`);\n        \n        const { score, ...result } = bestMatch; // Remove score before returning\n\n        try {\n          ProductServiceInfoSchema.parse(result);\n          return { success: true, productInfo: result, message: `Berhasil menemukan produk/layanan: ${result.name}.` };\n        } catch (zodError: any) {\n          console.error(\"ProductLookupTool Function: Zod validation error for found item:\", JSON.stringify(zodError.format(), null, 2));\n          console.error(\"ProductLookupTool Function: Data that failed validation:\", JSON.stringify(result, null, 2));\n          return { success: false, message: `Menemukan item yang cocok, namun data tidak valid. Item: ${bestMatch.name}.` };\n        }\n      } else {\n        console.log(`ProductLookupTool Function: Tidak ada produk/layanan yang cocok dengan nama \"${searchTerm}\".`);\n        return { success: false, message: `Tidak ada produk atau layanan yang cocok dengan nama \"${searchTerm}\".` };\n      }\n    } catch (error) {\n      console.error('ProductLookupTool Function: Error saat mengambil data dari Firestore:', error);\n      return { success: false, message: \"Terjadi kesalahan internal saat mencari data di database.\" };\n    }\n}\n\nexport const getProductServiceDetailsByNameTool = ai.defineTool(\n  {\n    name: 'getProductServiceDetailsByNameTool',\n    description: 'Mencari dan mengembalikan detail spesifik dari sebuah produk atau layanan berdasarkan namanya. Berguna untuk menjawab pertanyaan pelanggan tentang harga, durasi, ketersediaan, atau deskripsi item tertentu.',\n    inputSchema: ProductLookupInputSchema,\n    outputSchema: ProductLookupOutputSchema,\n  },\n  findProductServiceByName // Pass the actual function here\n);\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 617, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/types/booking.ts"],"sourcesContent":["\nimport type { Timestamp } from 'firebase/firestore';\nimport { z } from 'zod'; // Impor z dari genkit atau zod langsung\n\nexport type BookingStatus = 'Pending' | 'Confirmed' | 'In Queue' | 'Completed' | 'Cancelled' | 'Rescheduled';\n\nexport interface BookingEntry {\n  id?: string; // Firestore document ID\n  customerName: string;\n  customerPhone?: string;\n  clientId?: string;\n  serviceId: string; // ID dari katalog 'services'\n  serviceName: string; // Nama layanan (bisa termasuk varian)\n  vehicleInfo: string;\n  bookingDateTime: Timestamp; // Tanggal dan waktu booking\n  estimatedDuration?: string;\n  status: BookingStatus;\n  notes?: string;\n  queueItemId?: string; // ID item di antrian jika sudah masuk\n  createdAt: Timestamp;\n  updatedAt: Timestamp;\n  source?: 'WhatsApp' | 'Manual' | 'Online';\n}\n\n// Schema untuk input CreateBookingTool\nexport const CreateBookingToolInputSchema = z.object({\n  customerName: z.string().describe(\"Nama lengkap pelanggan.\"),\n  customerPhone: z.string().optional().describe(\"Nomor telepon pelanggan (jika ada, format internasional mis. 628xxxx).\"),\n  clientId: z.string().optional().describe(\"ID klien terdaftar (jika ada).\"),\n  serviceId: z.string().describe(\"ID layanan/produk yang dibooking dari katalog.\"),\n  serviceName: z.string().describe(\"Nama layanan/produk yang dibooking (termasuk varian jika ada).\"),\n  vehicleInfo: z.string().describe(\"Informasi kendaraan (mis. 'Honda Vario (B 1234 XYZ)').\"),\n  bookingDate: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Tanggal booking dalam format YYYY-MM-DD.\").describe(\"Tanggal booking (YYYY-MM-DD).\"),\n  bookingTime: z.string().regex(/^([01]\\d|2[0-3]):([0-5]\\d)$/, \"Waktu booking dalam format HH:MM (24 jam).\").describe(\"Waktu booking (HH:MM, 24 jam).\"),\n  estimatedDuration: z.string().optional().describe(\"Estimasi durasi layanan.\"),\n  notes: z.string().optional().describe(\"Catatan tambahan untuk booking.\"),\n});\nexport type CreateBookingToolInput = z.infer<typeof CreateBookingToolInputSchema>;\n\n// Schema untuk output CreateBookingTool\nexport const CreateBookingToolOutputSchema = z.object({\n  success: z.boolean().describe(\"Apakah pembuatan booking berhasil atau tidak.\"),\n  bookingId: z.string().optional().describe(\"ID booking yang baru dibuat jika berhasil.\"),\n  queueItemId: z.string().optional().describe(\"ID item antrian jika booking untuk hari ini dan berhasil ditambahkan ke antrian.\"),\n  message: z.string().describe(\"Pesan hasil proses booking (mis. konfirmasi atau error).\"),\n  status: z.string().optional().describe(\"Status booking setelah dibuat.\"),\n});\nexport type CreateBookingToolOutput = z.infer<typeof CreateBookingToolOutputSchema>;\n\n// Referensi dari /bookings/page.tsx (untuk form manual di UI, bukan tool AI)\nexport interface ManualBookingFormData {\n  customerName: string;\n  clientId?: string;\n  vehicleInfo: string;\n  serviceId: string;\n  variantId?: string;\n  bookingDate: Date;\n  bookingTime: string; // HH:MM\n  notes?: string;\n  source: 'Manual' | 'WhatsApp' | 'Online';\n}\n"],"names":[],"mappings":";;;;AAEA,kSAAyB,wCAAwC;AAAjE;;AAuBO,MAAM,+BAA+B,iLAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IACnD,cAAc,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAClC,eAAe,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAC9C,UAAU,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACzC,WAAW,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC/B,aAAa,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IACjC,aAAa,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IACjC,aAAa,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,KAAK,CAAC,uBAAuB,4CAA4C,QAAQ,CAAC;IAC1G,aAAa,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,KAAK,CAAC,+BAA+B,8CAA8C,QAAQ,CAAC;IACpH,mBAAmB,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAClD,OAAO,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;AACxC;AAIO,MAAM,gCAAgC,iLAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IACpD,SAAS,iLAAA,CAAA,IAAC,CAAC,OAAO,GAAG,QAAQ,CAAC;IAC9B,WAAW,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAC1C,aAAa,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAC5C,SAAS,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC7B,QAAQ,iLAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;AACzC","debugId":null}},
    {"offset": {"line": 649, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/ai/tools/createBookingTool.ts"],"sourcesContent":["\n'use server';\n/**\n * @fileOverview Genkit tool for creating new bookings.\n */\nimport { ai } from '@/ai/genkit';\nimport { z } from 'zod';\nimport { db } from '@/lib/firebase';\nimport { collection, addDoc, serverTimestamp, Timestamp, updateDoc, doc } from 'firebase/firestore';\nimport { CreateBookingToolInputSchema, CreateBookingToolOutputSchema, type CreateBookingToolInput, type CreateBookingToolOutput } from '@/types/booking';\nimport { type ServiceProduct } from '@/app/(app)/services/page';\nimport { isSameDay, setHours, setMinutes, parse } from 'date-fns';\n\nasync function createBookingImplementation(input: CreateBookingToolInput): Promise<CreateBookingToolOutput> {\n  console.log(\"[createBookingTool] Input received:\", JSON.stringify(input, null, 2));\n\n  try {\n    // 1. Validasi input (sudah dilakukan oleh Zod, tapi bisa tambah validasi kustom di sini)\n    const parsedDate = parse(input.bookingDate, 'yyyy-MM-dd', new Date());\n    if (isNaN(parsedDate.getTime())) {\n      return { success: false, message: \"Format tanggal booking tidak valid.\" };\n    }\n    const [hour, minute] = input.bookingTime.split(':').map(Number);\n    const bookingDateTime = setMinutes(setHours(parsedDate, hour), minute);\n    const bookingTimestamp = Timestamp.fromDate(bookingDateTime);\n\n    // 2. Ambil detail layanan untuk estimasi durasi (jika belum ada)\n    let estimatedDuration = input.estimatedDuration;\n    if (!estimatedDuration && input.serviceId) {\n      try {\n        const serviceDocRef = doc(db, 'services', input.serviceId);\n        const serviceSnap = await serviceDocRef.get();\n        if (serviceSnap.exists()) {\n          const serviceData = serviceSnap.data() as ServiceProduct;\n          estimatedDuration = serviceData.estimatedDuration || 'N/A';\n          // Jika ada varian, idealnya sudah ditangani di input.serviceName dan input.estimatedDuration\n        }\n      } catch (e) {\n        console.warn(\"[createBookingTool] Gagal mengambil durasi dari serviceId, akan menggunakan N/A jika tidak ada di input.\", e);\n      }\n    }\n\n    // 3. Siapkan data untuk Firestore\n    const bookingDataPayload: Omit<import('@/types/booking').BookingEntry, 'id' | 'createdAt' | 'updatedAt' | 'queueItemId'> = {\n      customerName: input.customerName,\n      clientId: input.clientId,\n      customerPhone: input.customerPhone,\n      vehicleInfo: input.vehicleInfo,\n      serviceId: input.serviceId,\n      serviceName: input.serviceName,\n      bookingDateTime: bookingTimestamp,\n      status: 'Confirmed', // Atau 'Pending' jika perlu konfirmasi manual\n      notes: input.notes,\n      source: 'WhatsApp', // Asumsi dari AI\n      estimatedDuration: estimatedDuration || 'N/A',\n    };\n\n    // 4. Simpan ke koleksi 'bookings'\n    const bookingDocRef = await addDoc(collection(db, \"bookings\"), {\n      ...bookingDataPayload,\n      createdAt: serverTimestamp(),\n      updatedAt: serverTimestamp(),\n    });\n    console.log(`[createBookingTool] Booking berhasil dibuat dengan ID: ${bookingDocRef.id}`);\n\n    let queueItemId: string | undefined = undefined;\n    let queueMessage: string = \"\";\n\n    // 5. Jika booking untuk hari ini, tambahkan ke 'queueItems'\n    if (isSameDay(bookingDateTime, new Date())) {\n      const queueItemData = {\n        customerName: input.customerName,\n        clientId: input.clientId,\n        vehicleInfo: input.vehicleInfo,\n        service: input.serviceName,\n        serviceId: input.serviceId,\n        // variantId: (jika ada dan disimpan di input, perlu ditambahkan ke schema input tool)\n        status: 'Menunggu' as 'Menunggu',\n        estimatedTime: estimatedDuration || 'N/A',\n        bookingId: bookingDocRef.id,\n        createdAt: bookingTimestamp, // Waktu booking jadi createdAt antrian\n      };\n      const queueDocRef = await addDoc(collection(db, 'queueItems'), queueItemData);\n      queueItemId = queueDocRef.id;\n      await updateDoc(bookingDocRef, { queueItemId: queueDocRef.id, status: 'In Queue' });\n      console.log(`[createBookingTool] Booking untuk hari ini, ditambahkan ke antrian dengan ID: ${queueItemId}`);\n      queueMessage = \" dan sudah masuk antrian hari ini.\";\n    }\n\n    return {\n      success: true,\n      bookingId: bookingDocRef.id,\n      queueItemId: queueItemId,\n      message: `Booking untuk ${input.customerName} pada ${input.bookingDate} jam ${input.bookingTime} untuk layanan \"${input.serviceName}\" berhasil dibuat${queueMessage}`,\n      status: queueItemId ? 'In Queue' : 'Confirmed',\n    };\n\n  } catch (error: any) {\n    console.error('[createBookingTool] Error:', error);\n    return {\n      success: false,\n      message: `Gagal membuat booking: ${error.message || 'Kesalahan internal server.'}`,\n    };\n  }\n}\n\nexport const createBookingTool = ai.defineTool(\n  {\n    name: 'createBookingTool',\n    description: 'Membuat jadwal booking baru untuk pelanggan di sistem. Gunakan setelah semua detail (nama, layanan, motor, tanggal, jam) dikonfirmasi.',\n    inputSchema: CreateBookingToolInputSchema,\n    outputSchema: CreateBookingToolOutputSchema,\n  },\n  createBookingImplementation\n);\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 780, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/ai/tools/knowledgeBaseRetrieverTool.ts"],"sourcesContent":["\n'use server';\n/**\n * @fileOverview Genkit tool to retrieve relevant knowledge base entries and services using vector similarity.\n */\n\nimport { ai } from '@/ai/genkit';\nimport { z } from 'zod';\nimport { db } from '@/lib/firebase';\nimport { collection, query, where, getDocs } from 'firebase/firestore';\nimport type { KnowledgeBaseEntry } from '@/types/knowledgeBase';\nimport type { ServiceProduct } from '@/app/(app)/services/page';\n\nconst KnowledgeBaseRetrieverInputSchema = z.object({\n  query: z.string().describe('The user question to find relevant knowledge for.'),\n});\n\nconst KnowledgeBaseRetrieverOutputSchema = z.array(\n  z.object({\n    topic: z.string().describe(\"The topic of the knowledge base entry or service name.\"),\n    content: z.string().describe(\"The content of the knowledge base entry or service description.\"),\n  })\n).describe(\"A list of relevant entries from the knowledge base and service catalog, or an empty list if none are found.\");\n\ninterface ScoredEntry {\n  topic: string;\n  content: string;\n  score: number;\n}\n\n/**\n * Calculates the cosine similarity between two vectors.\n * @param vecA The first vector.\n * @param vecB The second vector.\n * @returns The cosine similarity score (0 to 1).\n */\nfunction cosineSimilarity(vecA: number[], vecB: number[]): number {\n  if (vecA.length !== vecB.length || vecA.length === 0) {\n    return 0;\n  }\n  let dotProduct = 0;\n  let magnitudeA = 0;\n  let magnitudeB = 0;\n  for (let i = 0; i < vecA.length; i++) {\n    dotProduct += vecA[i] * vecB[i];\n    magnitudeA += vecA[i] * vecA[i];\n    magnitudeB += vecB[i] * vecB[i];\n  }\n  magnitudeA = Math.sqrt(magnitudeA);\n  magnitudeB = Math.sqrt(magnitudeB);\n  if (magnitudeA === 0 || magnitudeB === 0) {\n    return 0;\n  }\n  return dotProduct / (magnitudeA * magnitudeB);\n}\n\nexport const knowledgeBaseRetrieverTool = ai.defineTool(\n  {\n    name: 'knowledgeBaseRetrieverTool',\n    description: \"Searches the internal knowledge base AND the service/product catalog for information relevant to a user's query. Use this first to get context before answering questions about policies, general information, or to find suitable services based on a user's problem description.\",\n    inputSchema: KnowledgeBaseRetrieverInputSchema,\n    outputSchema: KnowledgeBaseRetrieverOutputSchema,\n  },\n  async (input) => {\n    console.log(`[knowledgeBaseRetrieverTool] Received query: \"${input.query}\"`);\n    try {\n      // 1. Generate an embedding for the user's query\n      const { embedding: queryEmbedding } = await ai.embed({\n        model: 'googleai/text-embedding-004',\n        content: input.query,\n      });\n\n      // 2. Fetch all active KB entries and all services in parallel\n      const kbCollectionRef = collection(db, 'knowledge_base_entries');\n      const servicesCollectionRef = collection(db, 'services');\n      \n      const kbQuery = query(kbCollectionRef, where('isActive', '==', true));\n      const servicesQuery = query(servicesCollectionRef);\n\n      const [kbSnapshot, servicesSnapshot] = await Promise.all([\n        getDocs(kbQuery),\n        getDocs(servicesQuery),\n      ]);\n      \n      // 3. Score Knowledge Base entries\n      const scoredKbEntries: ScoredEntry[] = kbSnapshot.docs\n        .map(doc => ({ id: doc.id, ...doc.data() } as KnowledgeBaseEntry))\n        .filter(entry => entry.embedding && Array.isArray(entry.embedding) && entry.embedding.length > 0)\n        .map(entry => ({\n          topic: entry.topic,\n          content: entry.content,\n          score: cosineSimilarity(queryEmbedding, entry.embedding!),\n        }));\n\n      // 4. Score Service/Product entries\n      const scoredServiceEntries: ScoredEntry[] = servicesSnapshot.docs\n        .map(doc => ({ id: doc.id, ...doc.data() } as ServiceProduct & { embedding?: number[] }))\n        .filter(service => service.embedding && Array.isArray(service.embedding) && service.embedding.length > 0)\n        .map(service => ({\n          topic: service.name,\n          content: service.description || 'Tidak ada deskripsi detail.',\n          score: cosineSimilarity(queryEmbedding, service.embedding!),\n        }));\n\n      // 5. Combine, sort, filter, and take the top N results\n      const allScoredEntries = [...scoredKbEntries, ...scoredServiceEntries];\n      const topN = 5;\n      const similarityThreshold = 0.65; // Adjusted threshold\n      \n      const relevantEntries = allScoredEntries\n        .sort((a, b) => b.score - a.score)\n        .filter(entry => entry.score > similarityThreshold)\n        .slice(0, topN);\n\n      console.log(`[knowledgeBaseRetrieverTool] Found ${relevantEntries.length} relevant entries from KB and Services.`);\n      \n      // 6. Format the output (remove score)\n      return relevantEntries.map(({ topic, content }) => ({\n        topic,\n        content,\n      }));\n\n    } catch (error) {\n      console.error('[knowledgeBaseRetrieverTool] Error during retrieval:', error);\n      return [];\n    }\n  }\n);\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 901, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/ai/flows/cs-whatsapp-reply-flow.ts"],"sourcesContent":["\n'use server';\n/**\n * @fileOverview Flow AI utama untuk WhatsApp Customer Service QLAB.\n * Sekarang menangani semua logika layanan dan menyimpan konteks percakapan di Firestore.\n */\nimport { ai } from '@/ai/genkit';\nimport * as z from 'zod';\nimport { db } from '@/lib/firebase';\nimport { doc, getDoc as getFirestoreDoc, setDoc as setFirestoreDoc, serverTimestamp, type Timestamp } from 'firebase/firestore';\nimport { DEFAULT_MAIN_PROMPT_ZOYA } from '@/types/aiSettings';\nimport { format, addDays, parse as parseDateFns } from 'date-fns'; // Import date-fns\n\nimport { getProductServiceDetailsByNameTool } from '@/ai/tools/productLookupTool';\nimport { createBookingTool } from '@/ai/tools/createBookingTool';\nimport { knowledgeBaseRetrieverTool } from '@/ai/tools/knowledgeBaseRetrieverTool';\n\n// Skema internal untuk validasi input chat history di flow\nconst ChatMessageSchemaInternal = z.object({\n  role: z.enum(['user', 'model']),\n  content: z.string(),\n});\nexport type ChatMessage = z.infer<typeof ChatMessageSchemaInternal>;\n\n\n// Skema input utama untuk ZoyaChatFlow (digunakan oleh UI)\nconst ZoyaChatInputSchema = z.object({\n  messages: z.array(ChatMessageSchemaInternal).optional().describe(\"Riwayat percakapan lengkap, jika ada.\"),\n  customerMessage: z.string().min(1, \"Pesan pelanggan tidak boleh kosong.\").describe(\"Pesan terbaru dari customer.\"),\n  senderNumber: z.string().optional().describe(\"Nomor WhatsApp pengirim (WAJIB untuk session jika mau persisten).\"),\n  mainPromptString: z.string().optional().describe(\"String prompt utama yang mungkin dikirim dari UI atau diambil dari Firestore.\"),\n  // Tanggal-tanggal ini akan diisi oleh wrapper function\n  currentDate: z.string().optional(),\n  currentTime: z.string().optional(),\n  tomorrowDate: z.string().optional(),\n  dayAfterTomorrowDate: z.string().optional(),\n  // Input dari UI untuk override/seed sesi. Sesi Firestore akan jadi sumber utama jika ada.\n  knownMotorcycleInfo: z.object({\n    name: z.string(),\n    size: z.string().optional(),\n  }).optional().describe(\"Informasi motor pelanggan jika sudah diketahui dari interaksi sebelumnya atau database.\"),\n  activeSpecificServiceInquiry: z.string().optional().describe(\"Layanan spesifik yang sedang aktif ditanyakan jika Zoya sebelumnya bertanya tipe motor untuk layanan ini.\"),\n});\nexport type ZoyaChatInput = z.infer<typeof ZoyaChatInputSchema>;\n\n// Schema output untuk wrapper function (digunakan oleh UI)\nconst WhatsAppReplyOutputSchema = z.object({\n  suggestedReply: z.string().describe('Saran balasan yang dihasilkan AI untuk dikirim ke pelanggan.'),\n  sessionActiveSpecificServiceInquiry: z.string().optional(),\n  sessionDetectedMotorcycleInfo: z.object({ name: z.string(), size: z.string().optional() }).optional(),\n  sessionLastAiInteractionType: z.string().optional(),\n});\nexport type WhatsAppReplyOutput = z.infer<typeof WhatsAppReplyOutputSchema>;\n\n\n// Flow utama\nconst zoyaChatFlow = ai.defineFlow(\n  {\n    name: 'zoyaChatFlow',\n    inputSchema: ZoyaChatInputSchema,\n    outputSchema: WhatsAppReplyOutputSchema,\n  },\n  async (input: ZoyaChatInput): Promise<WhatsAppReplyOutput> => {\n    console.log(\"[MAIN-FLOW] zoyaChatFlow input:\", JSON.stringify(input, null, 2));\n\n    let customerMessageToProcess = input.customerMessage;\n    let suggestedReply = \"Maaf, Zoya lagi bingung nih.\";\n    \n    if (!customerMessageToProcess || customerMessageToProcess.trim() === '') {\n      return { suggestedReply: \"Maaf, Zoya tidak menerima pesan yang jelas.\" };\n    }\n    \n    const finalSystemPrompt = input.mainPromptString || DEFAULT_MAIN_PROMPT_ZOYA;\n\n    const historyForAI = (input.messages || [])\n      .filter(msg => msg.content && msg.content.trim() !== '')\n      .map((msg) => ({\n        role: msg.role,\n        content: [{ text: msg.content }],\n    }));\n\n    const messagesForAI = [\n      ...historyForAI,\n      { role: 'user' as const, content: [{ text: customerMessageToProcess }] }\n    ];\n\n    console.log(`[MAIN-FLOW] Calling MAIN ai.generate. History Length: ${historyForAI.length}. Prompt snippet: ${finalSystemPrompt.substring(0, 300)}...`);\n    \n    try {\n      const result = await ai.generate({\n        model: 'googleai/gemini-1.5-flash-latest',\n        prompt: finalSystemPrompt,\n        messages: messagesForAI,\n        tools: [knowledgeBaseRetrieverTool, getProductServiceDetailsByNameTool, createBookingTool],\n        toolChoice: 'auto',\n        config: {\n            temperature: 0.5,\n            topP: 0.9,\n        },\n      });\n\n      suggestedReply = result.text || `Maaf, Zoya tidak bisa memberikan jawaban saat ini. (Finish Reason: ${result.finishReason})`;\n      console.log(`[MAIN-FLOW] Final response text: \"${suggestedReply}\"`);\n\n      // We are simplifying the session management logic for now to rely on the RAG approach.\n      // The AI's statefulness is now primarily in the conversation history, not complex session flags.\n      return {\n        suggestedReply,\n      };\n\n    } catch (flowError: any) {\n        console.error(\"[MAIN-FLOW] ❌ Critical error dalam MAIN zoyaChatFlow:\", flowError);\n        if (flowError.cause) console.error(\"[MAIN-FLOW] Error Cause:\", JSON.stringify(flowError.cause, null, 2));\n        return { suggestedReply: `Waduh, Zoya lagi error nih, boskuu. Coba tanya lagi nanti ya. (Error: ${flowError.message || 'Kesalahan internal'})` };\n    }\n  }\n);\n\n\nexport async function generateWhatsAppReply(input: ZoyaChatInput): Promise<WhatsAppReplyOutput> {\n  console.log(\"[MAIN-FLOW Wrapper] generateWhatsAppReply input:\", JSON.stringify(input, null, 2));\n\n  let mainPromptToUse = input.mainPromptString;\n\n  if (!mainPromptToUse && db) {\n    try {\n        const settingsDocRef = doc(db, 'appSettings', 'aiAgentConfig');\n        const docSnap = await getFirestoreDoc(settingsDocRef);\n        if (docSnap.exists() && docSnap.data()?.mainPrompt) {\n          mainPromptToUse = docSnap.data().mainPrompt;\n          console.log(\"[MAIN-FLOW Wrapper]: Using mainPromptString from Firestore.\");\n        } else {\n          mainPromptToUse = DEFAULT_MAIN_PROMPT_ZOYA;\n          console.log(\"[MAIN-FLOW Wrapper]: Using DEFAULT_MAIN_PROMPT_ZOYA (Firestore doc not found or no mainPrompt).\");\n        }\n    } catch (error) {\n      console.error(\"[MAIN-FLOW Wrapper]: Error fetching mainPrompt from Firestore. Using default.\", error);\n      mainPromptToUse = DEFAULT_MAIN_PROMPT_ZOYA;\n    }\n  } else if (!mainPromptToUse) {\n     mainPromptToUse = DEFAULT_MAIN_PROMPT_ZOYA;\n     console.log(\"[MAIN-FLOW Wrapper]: Using DEFAULT_MAIN_PROMPT_ZOYA (db not available or prompt already provided).\");\n  } else {\n     console.log(\"[MAIN-FLOW Wrapper]: Using mainPromptString directly from input.\");\n  }\n\n  const today = new Date();\n  const flowInput: ZoyaChatInput = {\n    ...input,\n    messages: input.messages || [],\n    mainPromptString: mainPromptToUse,\n    currentDate: format(today, 'yyyy-MM-dd'),\n    currentTime: format(today, 'HH:mm'),\n    tomorrowDate: format(addDays(today, 1), 'yyyy-MM-dd'),\n    dayAfterTomorrowDate: format(addDays(today, 2), 'yyyy-MM-dd'),\n  };\n\n  try {\n    const result = await zoyaChatFlow(flowInput);\n    return result;\n  } catch (error: any) {\n    console.error(\"[MAIN-FLOW Wrapper] Error running zoyaChatFlow:\", error);\n    return { suggestedReply: `Maaf, Zoya sedang ada kendala teknis. (${error.message || 'Tidak diketahui'})` };\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1090, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/.next-internal/server/app/%28app%29/ai-cs-assistant/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {generateWhatsAppReply as '4053660f6447b38038e1d20965a3df3cd57a2a7b51'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}},
    {"offset": {"line": 1154, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/ai-cs-assistant/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(app)/ai-cs-assistant/page.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(app)/ai-cs-assistant/page.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAA0S,GACvU,wEACA","debugId":null}},
    {"offset": {"line": 1168, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/ai-cs-assistant/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(app)/ai-cs-assistant/page.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(app)/ai-cs-assistant/page.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAAsR,GACnT,oDACA","debugId":null}},
    {"offset": {"line": 1182, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}}]
}